%%--------------------Chapter 3------------------------
\chapter{Thetis Design} \label{chap:thetis_design}

\section{Stakeholders} \label{sec:stakeholders}
As with any project, stakeholders are a crucial part of the design process.
Stakeholders drive certain requirements that the device must achieve in order to be accepted for operation.
On an individual level, the committee overseeing this thesis are the major stakeholders as they have a vested interest in the success or failure of the project.
However, there are some organizational-level stakeholders that have also expressed interest in the project and provided some feedback for their requirements.
A summary of the stakeholders is provided in Table \ref{tab:stakeholders}.

\begin{table}
	\caption{A summary of stakeholders of the Thetis device}
	\label{tab:stakeholders}
	\centering
	\begin{tabular}{|p{0.3\linewidth} | p{0.6\linewidth}|}
		\hline
		\rowcolor[gray]{0.8}
		\multicolumn{1}{|c|}{\textbf{Stakeholder}} & \multicolumn{1}{|c|}{\textbf{Description}} \\
		\hline
		Committee members & Individual professors who have expressed interest in the project and have agreed to assist in its development. Specifically, Dr. Wood and Dr. Weaver would like to deploy Thetis on university projects; Dr. Gutierrez has provided many requirements on the performance of the instrumentation; and Dr. Silaghi is interested in its application to autonomous navigation. \\
		\hline
		Florida Institute of \newline Technology & The university has several classes and projects where the Thetis design could be useful. The Instrumentation Design and Analysis class used Thetis as a demonstrator for designing PCBs and field experiments. Thetis was also designed with Surf Engineering Analysis in mind for students to have a new open source sensor to experiment with. \\
		\hline
		NSWC Carderock - \newline Combatant Craft Division (CCD) & This three-letter agency of the government has expressed interest in using Thetis as a testing and evaluation tool for small unmanned crafts \\
		\hline
	\end{tabular}
\end{table}

\subsection{Hands-On Users} \label{ssec:hands_on_users}

\section{Design Rationale} \label{sec:design_rationale}
Thetis is envisioned as an open-source all-in-one data logging solution for use in research projects.
The device incorporates multiple sensors, GPS tracking, and a WiFi-capable microcontroller in order to enable as many features as can be envisioned by the end users.
One of the driving considerations was the small footprint.
Thetis Revision F is designed to fit into one of the smallest IP67-rated enclosures available on the market [LINK].  
This tiny form factor allows it to be inconspicuously mounted to any floating body like surfboards, scale models, or wave buoys without upsetting their inertial characteristics or impeding nominal operation.

Further discussions with stakeholders later in the design process envisioned a new iteration, Revision G, that had a larger footprint, but added more capabilities like CANbus integration and several connection ports for different communication protocols.
This revision is meant for deployment on vessels that have a NMEA2000 communications bus.
This bus allows the device to be powered from the boat's power supply and communicate data to a central controller.
These features are extremely important for the final application where Thetis is meant to feed data into a navigation algorithm for the safe passage of unmanned vessels.

\subsection{Problem Description} \label{ssec:problem_desc}
Tracking the inertial movements of small floating bodies in-situ is difficult for small-scale or student-led experiments.
The price of the measurement instruments and the data acquisition computers (DAQs) offers a high bar for entry for these projects.
Also, the size of these instruments and DAQs can negatively impact the performance or operation of small floating bodies so they cannot be effectively used.
This forces classrooms and organizations to either neglect collecting inertial data or using bulky, unreliable prototype setups using off-the-shelf components

\subsection{Mission Statement} \label{ssec:mission_statement}
Thetis aims to democratize the inertial measurement and tracking space for small scale experiments by implementing an open-source, feature-rich, all-in-one solution to monitoring the movements of floating bodies.

\subsection{Stakeholder Requirements} \label{ssec:stakeholder_reqs}
Interviews with the stakeholders occurred over several months and informed a set of requirements that they determined were necessary for the project's success.

\begin{itemize}
	\item[\textbf{SR 01}] - The system shall be able to record acceleration, rotation rate, orientation, and position
	\item[\textbf{SR 02}] - The system shall be able to fit into a small IP67-rated, or better, enclosure
	\item[\textbf{SR 03}] - The system shall be able to fit into a small IP67-rated, or better, enclosure
	\item[\textbf{SR 04}] - The system shall be cheaper than \$200 per unit
	\item[\textbf{SR 05}] - The system shall use components that are readily available COTS
	\item[\textbf{SR 06}] - The system designs shall be open source for modification by students
	\item[\textbf{SR 07}] - The system shall communicate intra-device using known IEEE standards (e.g. SPI/I2C/UART/etc)
	\item[\textbf{SR 08}] - The system shall communicate extra-device using WiFi and USB
	\item[\textbf{SR 09}] - They system shall have enough on-board storage for 4 hours of continuously logging at 64 Hz
	\item[\textbf{SR 10}] - Thetis Revision G shall be able to communicate extra-device using CANbus
	\item[\textbf{SR 11}] - The system shall have redundant storage for device and communication events
\end{itemize}


\subsection{Risk Identification} \label{ssec:risk_identification}
The following tables explore some of the larger risks associated with each of the stakeholder requirements.
Risks are categorized into several types: Technical, Cost, Schedule, Organizational, and Operational.
Each risk has an associated consequence on the project's development and a severity rating from "Low" to "High".
With every risk, we can apply a mitigation to it to reduce the severity of the consequence.

\paragraph*{Technical Risks} These are risks that pose a technical challenge to the project such as sensor accuracies, programming difficulty, or component specifications. 
These risks are likely to impede the development of Thetis by showing up during testing and forcing workarounds after the fact, rather than before.

\paragraph*{Cost Risks} These risks pose a threat to Thetis's development budget.
They are more likely to manifest in the supply chain of Thetis, especially in the after effects of the COVID-19 pandemic and the chaos of the chip shortage.
More often, mitigating these risks requires some careful planning and a larger budget and will typically not impede the development process.

\paragraph*{Schedule Risks} By delaying the program's development, Schedule Risks are the most notorious and costly of them all.
These risks manifest as delays in development or the supply chain and can significantly impact the expected delivery time of the device.
They also are prominent across all phases of the design process from planning to testing and are only mitigated, but never eliminated during the design spiral.

\paragraph*{Organization Risks} The stakeholders represent various organizations that have an interest in Thetis.
This risk type poses a problem for the specific stakeholder organization and their interests.
This can be viewed from the political, economical, or schedule points of view as these are important considerations for the stakeholders.

\paragraph*{Operational Risks} These risks challenge end users of the device while they are testing.
Most of them can be mitigated in the design process by working directly with the end users and ensuring their concerns are met.
However, the majority of them will only manifest during testing and must be mitigated after the fact.
This could mean substantial cost increases and schedule delays depending on the severity of the risk.

\begin{landscape}


% ==================================
% === STAKEHOLDER REQUIREMENT XX ===
% ==================================


% \paragraph*{SR XX} - 

% {\fontsize{8pt}{8pt}\selectfont
% \begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
% 	\hline \endlastfoot
	
% 	\hline
% 	\rowcolor[gray]{0.8}
% 	\multicolumn{6}{|c|}{ } \\
% 	\hline
% 	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{} \\
% 	\hline
% 	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{} \\
% 	\hline
% 	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{} \\
% 	\hline
% 	\rowcolor[gray]{0.8}
% 	\multicolumn{6}{|c|}{ } \\
% 	\hline
% 	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
% 	\hline
% 	Technical \newline Assessment &  &  & \cellcolor{} &  & \cellcolor{} \\
% 	\hline
% 	Cost \newline Assessment &  &  & \cellcolor{} &  & \cellcolor{} \\
% 	\hline
% 	Schedule \newline Assessment &  &  & \cellcolor{} &  & \cellcolor{} \\
% 	\hline
% 	Organizational \newline Assessment &  &  & \cellcolor{}  &  & \cellcolor{}  \\
% 	\hline
% 	Operational \newline Assessment &  &  & \cellcolor{} &  & \cellcolor{}
% 	\label{tab:sr01_feasibility}
% \end{longtable}
% }
% \newpage


% ==================================
% === STAKEHOLDER REQUIREMENT 01 ===
% ==================================


\paragraph*{SR 01} - The system shall be able to record acceleration, rotation rate, orientation, and position

{\fontsize{8pt}{8pt}\selectfont
\begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
	\hline \endlastfoot
	
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{Dr. Stephen Wood} \\
	\hline
	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{The system needs to be able to record the inertial characteristics of a floating body} \\
	\hline
	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{This will be accomplished using a 9-DOF IMU and GPS receiver with accuracies not to exceed one standard deviation of a reference source} \\
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
	\hline
	Technical \newline Assessment & The IMU and/or GPS will report measurements that have a high margin of error and little consistency & Worthless data for analysis & \cellcolor{yellow} Medium & Selection of sensors that have decent accuracy and low drift. \newline Use a \emph{tuned} Kalman filter to improve reported sensor accuracy & \cellcolor{green} Low \\
	\hline
	Cost \newline Assessment & Chip shortage as a result of the COVID-19 pandemic. & Unable to find appropriate components. \newline Any found components are prohibitively expensive & \cellcolor{yellow} Medium & Find components that are in stock and order in bulk. & \cellcolor{yellow} Medium \\
	\hline
	Schedule \newline Assessment & Sensor fusion algorithms are difficult to implement and tune. & Schedule overrun trying to tune the algorithms. \newline Inaccuracies introduced through improper tuning. & \cellcolor{yellow} Medium & Good programming practices to make tuning easier during testing. & \cellcolor{green} Low \\
	\hline
	Organizational \newline Assessment & Lack of subject matter experts & Project cost and schedule delays & \cellcolor{green} Low & In-house team available. \newline Can reduce scope, as needed. \newline Proper documentation of progress and scheduled design reviews and consultations & \cellcolor{green} Low \\
	\hline
	Operational \newline Assessment & Unreliable sensors. & Device fails and does not recover during testing; lost data & \cellcolor{yellow} Medium & Reliability analysis and testing required. & \cellcolor{green} Low
	\label{tab:sr01_feasibility}
\end{longtable}
}
\newpage


% ==================================
% === STAKEHOLDER REQUIREMENT 02 ===
% ==================================


\paragraph*{SR 02} - The system shall be able to fit into a small IP67-rated, or better, enclosure

{\fontsize{8pt}{8pt}\selectfont
\begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
	\hline \endlastfoot
	
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{Dr. Robert Weaver} \\
	\hline
	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{Thetis's electronics need to be independently sealed from the elements, including being temporarily submerged } \\
	\hline
	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{The selected enclosure should have a UL-listing and have a verified IP rating that fits the requirement.} \\
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
	\hline
	Technical \newline Assessment & Unable to find a small enough IP-rated enclosure & Need to increase size that may violate size restrictions & \cellcolor{yellow} Medium & Extensive searching of online retailers of catalogs & \cellcolor{green} Low \\
	\hline
	Cost \newline Assessment & Small IP-67 rated enclosures are a niche item that may have to be custom-ordered and therefore expensive. & Enclosures may be prohibitively expensive and drive up program costs & \cellcolor{green} Low & Find reputable suppliers and order enclosures in bulk, if possible. & \cellcolor{green} Low \\
	\hline
	Schedule \newline Assessment & If the enclosures have to be custom ordered, there may be an extended lead time for delivery & Schedule orverruns & \cellcolor{yellow} Medium & Find reputable suppliers and order in bulk well ahead of time. \newline maintain a stock of several enclosures as spares. & \cellcolor{green} Low \\
	\hline
	Organizational \newline Assessment & N/A & N/A & \cellcolor[gray]{0.8} & N/A & \cellcolor[gray]{0.8} \\
	\hline
	Operational \newline Assessment & IP-rating is not valid. \newline Enclosure is not fully sealed. \newline Operation exceeds rated limits & Chamber floods, damaging equipment, causing a potential fire hazard and data loss. & \cellcolor{red} High & Reputable supplier and traceable IP-rating. \newline End user vigilence to ensure enclosure is fully closed and sealed. & \cellcolor{yellow} Medium
	\label{tab:sr02_feasibility}
\end{longtable}
}
\newpage

% ==================================
% === STAKEHOLDER REQUIREMENT 03 ===
% ==================================


\paragraph*{SR 03} - The system shall be able to be powered by battery for more than 4 hours continuously

{\fontsize{8pt}{8pt}\selectfont
\begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
	\hline \endlastfoot
	
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{Dr. Robert Weaver} \\
	\hline
	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{Thetis is expected to deploy for a minimum of 3 hours on a typical deployment. Need margin for battery chemistry and preparation time.} \\
	\hline
	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{The device shall be deployed for a long period and } \\
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
	\hline
	Technical \newline Assessment & Device is not turned off before battery voltage is critically low & Battery is damaged and needs to be replaced; fire hazard & \cellcolor{yellow} Medium & Build the power regulator such that the device auto turns off before battery is damaged & \cellcolor{green} Low \\
	\hline
	Cost \newline Assessment & Larger capacity batteries are more expensive. \newline Damaged batteries need to be replaced & Cost overruns & \cellcolor{green} Low & Order batteries in bulk and ensure spares are available & \cellcolor{green} Low \\
	\hline
	Schedule \newline Assessment & If there are no spares, there may be delays in testing schedule & Any critical testing may have to be delayed, resulting in program delays & \cellcolor{green} Low & Order batteries in bulk and ensure spares are available & \cellcolor{green} Low \\
	\hline
	Organizational \newline Assessment & N/A & N/A & \cellcolor[gray]{0.8} & N/A & \cellcolor[gray]{0.8} \\
	\hline
	Operational \newline Assessment & Battery does not have enough capacity to support a 4 hour deployment & Data is lost & \cellcolor{yellow} Medium & Conservative power analysis and choosing an oversized battery. & \cellcolor{green} Low
	\label{tab:sr03_feasibility}
\end{longtable}
}
\newpage

% ==================================
% === STAKEHOLDER REQUIREMENT 04 ===
% ==================================


\paragraph*{SR 04} - The system shall be cheaper than \$200 per unit

{\fontsize{8pt}{8pt}\selectfont
\begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
	\hline \endlastfoot

	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{Dr. Robert Weaver} \\
	\hline
	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{Thetis is designed to be a cheap, expendable unit so that, when damaged by students, it is financially feasible to replace it. It needs to be cheaper than comparable devices} \\
	\hline
	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{The Bill of Materials for Thetis shall not exceed the required threshold.} \\
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
	\hline
	Technical \newline Assessment & Cheaper components (sensors) that are not as precise or accurate. & Less accurate data that may not be useful for analysis & \cellcolor{yellow} Medium & Use a \emph{tuned} Kalman filter to improve reported sensor accuracy & \cellcolor{green} Low \\
	\hline
	Cost \newline Assessment & Chip shortage as a result of the COVID-19 pandemic. \newline Small IP-67 rated enclosures are a niche item that may have to be custom-ordered & Parts significantly inflate the Bill of Materials cost & \cellcolor{yellow} Meidum & Source from reputable suppliers and purchase in bulk & \cellcolor{yellow} Medium \\
	\hline
	Schedule \newline Assessment & N/A & N/A & \cellcolor[gray]{0.8} & N/A & \cellcolor[gray]{0.8} \\
	\hline
	Organizational \newline Assessment & Bill of Materials cost exceeds requirement limit. \newline Development costs become too expensive & Invested stakeholders may pull support. \newline Hardware development slows or stops & \cellcolor{red} High & Purchase materials in bulk, when possible. \newline Use proper development techniques and analysis to reduce the number of hardware iterations and cost  & \cellcolor{yellow} Medium \\
	\hline
	Operational \newline Assessment & Cheaper, not as reliable parts. & Unexpected and unrecoverable failures during deployments & \cellcolor{yellow} Medium & Reliability analysis and testing required. & \cellcolor{green} Low
	\label{tab:sr04_feasibility}
\end{longtable}
}
\newpage


% ==================================
% === STAKEHOLDER REQUIREMENT 05 ===
% ==================================


\paragraph*{SR 05} - The system shall use components that are readily available COTS

{\fontsize{8pt}{8pt}\selectfont
\begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
	\hline \endlastfoot
	
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{Dr. Stephen Wood} \\
	\hline
	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{Using commercial off the shelf parts will reduce development time and costs. COTS parts will also make repair and maintenance easier} \\
	\hline
	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{All parts used on Thetis must be available from commercial suppliers and catalogs.} \\
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
	\hline
	Technical \newline Assessment & N/A & N/A & \cellcolor[gray]{0.8} & N/A & \cellcolor[gray]{0.8} \\
	\hline
	Cost \newline Assessment & Chip shortage as a result of the COVID-19 pandemic. \newline Small IP-67 rated enclosures are a niche item that may have to be custom-ordered & Parts significantly inflate the Bill of Materials cost & \cellcolor{yellow} Medium & Source from reputable suppliers and purchase in bulk & \cellcolor{green} Low \\
	\hline
	Schedule \newline Assessment & Parts are not available. \newline Small enclosure may have a long lead time & Development schedule should be delayed & \cellcolor{yellow} Medium & Order parts in bulk and ensure spares are available & \cellcolor{green} Low \\
	\hline
	Organizational \newline Assessment & The small enclosure may no longer be available from a commercial supplier & Forces a new design iteration to fit a new enclosure. \newline Forces end users to adapt to a new enclosure & \cellcolor{green} Low & Work with supplier to ensure supply chain; order in bulk. \newline 3D print older enclosure, if COTS is no longer available & \cellcolor{green} Low \\
	\hline
	Operational \newline Assessment & N/A & N/A & \cellcolor[gray]{0.8} & N/A & \cellcolor[gray]{0.8}
	\label{tab:sr05_feasibility}
\end{longtable}
}
\newpage


% ==================================
% === STAKEHOLDER REQUIREMENT 06 ===
% ==================================


\paragraph*{SR 06} - The system designs shall be open source for modification by students

{\fontsize{8pt}{8pt}\selectfont
\begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
	\hline \endlastfoot
	
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{Dr. Robert Weaver} \\
	\hline
	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{Thetis will need to be maintained while students use it for class projects. Therefore, they will need to have the ability to directly modify the hardware and software.} \\
	\hline
	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{All of the code and hardware will be published open source in GitHub repositories under an MIT license.} \\
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
	\hline
	Technical \newline Assessment & Designs are modified by students who unknowingly break functionality & Disabling or "bricking" Thetis, making it useless. \newline Loss of development history/"good" designs & \cellcolor{green} Low & GitHub tracks all commits and history. \newline "Good" designs are published as release snapshots and cannot be lost. & \cellcolor{green} Low \\
	\hline
	Cost \newline Assessment & New design modifications require more investment & Program cost increases as students change the design & \cellcolor{green} Low & Ensure that any design modifications go through a design review and adds substantial value to Thetis & \cellcolor{green} Low \\
	\hline
	Schedule \newline Assessment & New designs may require additional development time & New additions may not be ready in time for when students need them & \cellcolor{green} Low & Ensure a ready supply of spare parts. \newline Proper design practices to ensure students can easily add features & \cellcolor{green} Low \\
	\hline
	Organizational \newline Assessment & Thetis design may not be patentable and commercialized & Thetis cannot be patented since it is published open source & \cellcolor{red} High & Thetis can still be commercialized by providing board assembly and support services & \cellcolor{green} Low \\
	\hline
	Operational \newline Assessment & Vulnerabilities are found and exploited by bad actors & User data can be compromised \newline WiFi capability opens an attack vector to local network & \cellcolor{green} Low & Avoid implementation of OTA software updates \newline Use proper security techniques for FTP username and password & \cellcolor{green} Low
	\label{tab:sr06_feasibility}
\end{longtable}
}
\newpage

% ==================================
% === STAKEHOLDER REQUIREMENT 07 ===
% ==================================


\paragraph*{SR 07} - The system shall communicate intra-device using known IEEE standards (e.g. SPI/I2C/UART/etc) 

{\fontsize{8pt}{8pt}\selectfont
\begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
	\hline \endlastfoot
	
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{Dr. Hector Gutierrez} \\
	\hline
	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{Using standard communication busses to send to data between ICs on the device makes development and integration easier.} \\
	\hline
	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{} \\
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
	\hline
	Technical \newline Assessment & Selected ICs do not use a standard communication bus to transfer data to a microcontroller & Development time will need to be spent on a custom protocol layer & \cellcolor{yellow} Medium & Read device datasheets carefully to ensure they use standard protocols & \cellcolor{green} Low \\
	\hline
	Cost \newline Assessment & N/A & N/A & \cellcolor[gray]{0.8} & N/A & \cellcolor[gray]{0.8} \\
	\hline
	Schedule \newline Assessment & Selected ICs do not use a standard communication bus to transfer data to a microcontroller & Development time will need to be spent on a custom protocol layer & \cellcolor{yellow} Medium & Read device datasheets carefully to ensure they use standard protocols & \cellcolor{green} Low \\
	\hline
	Organizational \newline Assessment & Selected ICs do not use a standard communication bus to transfer data to a microcontroller & Future developers will have to study the custom protocol layer in order to understand how to add features & \cellcolor{yellow} Medium & Read device datasheets carefully to ensure they use standard protocols & \cellcolor{green} Low \\
	\hline
	Operational \newline Assessment & Selected ICs do not use a standard communication bus to transfer data to a microcontroller & Unintended bugs or data mistakes may be introduced by using a custom protocol layer & \cellcolor{yellow} Medium & Read device datasheets carefully to ensure they use standard protocols & \cellcolor{green} Low
	\label{tab:sr07_feasibility}
\end{longtable}
}
\newpage


% ==================================
% === STAKEHOLDER REQUIREMENT 08 ===
% ==================================


\paragraph*{SR 08} - The system shall communicate extra-device using WiFi and USB 

{\fontsize{8pt}{8pt}\selectfont
\begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
	\hline \endlastfoot
	
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{Dr. Robert Weaver} \\
	\hline
	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{A physical USB connection is crucial for programming and debugging Thetis. A WiFi connection would allow for wireless programming and data off-loading} \\
	\hline
	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{The microcontroller shall have a USB-compatible PHY and WiFi capability.} \\
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
	\hline
	Technical \newline Assessment & WiFi performance (speed/range) is too low and unacceptable & Data offloading is cumbersome. \newline Unable to monitor device while deployed & \cellcolor{yellow} Medium & Select microcontroller with known good WiFi-performance. \newline Select an appropriate antenna for the situation & \cellcolor{green} Low \\
	\hline
	Cost \newline Assessment & WiFi is not useful and not fully utilized & Cost per microcontroller is needlessly increased; inflated bill of materials cost & \cellcolor{yellow} Medium & Verify that WiFi functionality is desired by Stakeholders and end-users & \cellcolor{green} Low \\
	\hline
	Schedule \newline Assessment & Implementing WiFi functionality is difficult and increases complexity; feature creep. & Increased time to develop front end interface; schedule overruns & \cellcolor{red} High & Agile management to limit feature creep & \cellcolor{yellow} Medium \\
	\hline
	Organizational \newline Assessment & Some stakeholders may have electromagnetic emissions restrictions & To comply, WiFi functionality will need to be able to be disabled & \cellcolor{green} Low & Allow WiFi features to be disabled by uploading new firmware without those features, or allow users to toggle this function on/off in runtime using a configuration file. & \cellcolor{green} Low \\
	\hline
	Operational \newline Assessment & Operators may not have device that can connect to the device over WiFi & Data cannot be offloaded easily in-situ. \newline Wireless monitoring not possible & \cellcolor{green} Low & Ensure that there is always a physical backup for offloading data. \newline Physical lights or other indictors to display system status & \cellcolor{green} Low
	\label{tab:sr08_feasibility}
\end{longtable}
}
\newpage


% ==================================
% === STAKEHOLDER REQUIREMENT 09 ===
% ==================================


\paragraph*{SR 09} - They system shall have enough on-board storage for 4 hours of continuously logging at 64 Hz

{\fontsize{8pt}{8pt}\selectfont
\begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
	\hline \endlastfoot
	
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{Dr. Robert Weaver} \\
	\hline
	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{Thetis will be deployed for several hours and needs to continuously record data. Data rate should be as fast as possible to capture higher frequency oscillations.} \\
	\hline
	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{Storage devices shall be large enough to support a full-length deployment and record all data as fast as possible (>64 Hz)} \\
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
	\hline
	Technical \newline Assessment & Logger is not able to consistently achieve 64 Hz rate & Significant data loss on higher frequency oscillations & \cellcolor{yellow} Medium & Utilize fast storage mediums. \newline Increase microcontroller and communication clock speeds & \cellcolor{green} Low \\
	\hline
	Cost \newline Assessment & Small flash chips will not be sufficient to store the amount of data & More expensive data storage devices (micro SD cards) will have to be used; increase bill of materials cost & \cellcolor{yellow} & Find cheapest storage devices that can be used & \cellcolor{green} Low \\
	\hline
	Schedule \newline Assessment & Optimizing the logging functionality will take significant development time to be consistently as fast as possible & Schedule overruns & \cellcolor{red} High & Proper programming practices to optimize code wherever possible; reduce refactors & \cellcolor{yellow} Medium \\
	\hline
	Organizational \newline Assessment & N/A & N/A & \cellcolor[gray]{0.8}  & N/A & \cellcolor[gray]{0.8}  \\
	\hline
	Operational \newline Assessment & Inertial movements and oscillations will occur at higher frequencies than can be reasonably measured (>16 Hz) & Significant decrease in data accuracy and correlation to real-world motions & \cellcolor{red} High & Log as fast as possible. \newline Perform careful characterization to validate requirement is sufficient for expected motion environment. & \cellcolor{yellow} Medium
	\label{tab:sr09_feasibility}
\end{longtable}
}
\newpage


% ==================================
% === STAKEHOLDER REQUIREMENT 10 ===
% ==================================


\paragraph*{SR 10} - Revision G devices shall be capable of communicating extra-device over CANbus 2.0b

{\fontsize{8pt}{8pt}\selectfont
\begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
	\hline \endlastfoot
	
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{MARTAC, CCD} \\
	\hline
	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{Data from Thetis must be able to be reported to a main computer, without a USB or WiFi connection, using the NMEA2000 protocol} \\
	\hline
	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{Thetis will be able to communicate with another computer using the NMEA2000 protocol} \\
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
	\hline
	Technical \newline Assessment & Microcontroller does not support CANbus communication natively. \newline Adds significant processing overhead to handle messages & Additional devices needed onboard. \newline Logging or WiFi performance degraded & \cellcolor{red} High & Utilize external drivers for CANbus protocol. \newline Add options to enable/disable WiFi for increased performance & \cellcolor{green} Low \\
	\hline
	Cost \newline Assessment & Microcontroller does not support CANbus communication natively. \newline Component shortage due to COVID-19 pandemic & Additional devices needed onboard; inflated bill of materials cost & \cellcolor{yellow} Medium & Purchase components in bulk. \newline Research CANbus controllers and implementations carefully. & \cellcolor{green} Low \\
	\hline
	Schedule \newline Assessment & Need to implement CANbus support; feature creep. \newline Another SKU to develop and maintain & Schedule & \cellcolor{red} High & Agile management and proper programming practices & \cellcolor{yellow} Medium \\
	\hline
	Organizational \newline Assessment & Not all stakeholder organizations require this feature. \newline Another SKU to develop and maintain & Increased development time. \newline Need to add ability to switch on/off features. & \cellcolor{red} High & Proper management techniques and work with stakeholders and end users to ensure feature is properly implemented & \cellcolor{yellow} Medium \\
	\hline
	Operational \newline Assessment & Not all end users will need to use this feature & Need to add ability to switch on/off features & \cellcolor{yellow} Medium & Proper management techniques and work with stakeholders and end users to ensure feature is properly implemented & \cellcolor{yellow} Medium
	\label{tab:sr10_feasibility}
\end{longtable}
}
\newpage


% ==================================
% === STAKEHOLDER REQUIREMENT 11 ===
% ==================================


\paragraph*{SR 11} - The system shall have redundant storage for device and communication events

{\fontsize{8pt}{8pt}\selectfont
\begin{longtable}{| p{0.12\linewidth} | p{0.16\linewidth} |  p{0.20\linewidth} | p{0.08\linewidth} | p{0.20\linewidth} | p{0.08\linewidth} |}
	\hline \endlastfoot
	
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Stakeholder:} & \multicolumn{5}{|l|}{MARTAC, CCD} \\
	\hline
	\textbf{Rationale:} & \multicolumn{5}{|p{0.8\linewidth}|}{Thetis will need to be able to log CANbus commands as a part of the data analysis process. Also will need to record device events separately over a long deployment.} \\
	\hline
	\textbf{Fit Criterion:} & \multicolumn{5}{|p{0.8\linewidth}|}{Implement a separate, smaller storage device that is different than the main storage.} \\
	\hline
	\rowcolor[gray]{0.8}
	\multicolumn{6}{|c|}{ } \\
	\hline
	\textbf{Risk} & \textbf{Risk Issue} & \textbf{Risk Consequence} & \textbf{Initial Risk} & \textbf{Risk Mitigation} & \textbf{Risk \newline After \newline Mitigation} \\
	\hline
	Technical \newline Assessment & Microcontroller cannot handle two separate file systems simultaneously & Significant performance decrease due to buffer flushing. \newline Microcontroller crashes due to buffer overflow. & \cellcolor{yellow} Medium & Proper programming practices to manage and minimize memory usage & \cellcolor{green} Low \\
	\hline
	Cost \newline Assessment & Additional components required. \newline Parts shortage due to the COVID-19 pandemic. & Inflated bill of materials cost & \cellcolor{yellow} Medium & Find cheap, but reliable flash storage chips. \newline Purchase parts in bulk & \cellcolor{green} Low \\
	\hline
	Schedule \newline Assessment & Implementing redundant storage adds complexity & Potential schedule overruns & \cellcolor{red} High & Proper programming and management practices & \cellcolor{green} Low \\
	\hline
	Organizational \newline Assessment & Not all stakeholders require redundant storage. \newline Message logging may inadvertently log sensitive data. & Reduced performance due to increased processor overhead. \newline Unintended data leakages. & \cellcolor{yellow} Medium & Add feature to enable/disable redundant storage features. \newline Work closely with stakeholders and end users to ensure feature is used properly & \cellcolor{green} Low \\
	\hline
	Operational \newline Assessment & Higher capacity storage device fails and data is stored on secondary device & Reduced max deployment time. \newline Potential data loss. & \cellcolor{yellow} Medium & Ensure that firmware can handle seamless transition between storage devices. \newline Ensure that secondary storage device is large enough to fulfill SR 03. & \cellcolor{green} Low
	\label{tab:sr11_feasibility}
\end{longtable}
}
\newpage

\end{landscape}

\subsection{Quality Functional Deployment} \label{ssec:qfd}
In engineering, there are a variety of customers that need to have their needs met.
These customers can be internal or external to the project and most were described in Section \ref{sec:stakeholders}.
To ensure that Thetis is designed with the stakeholders in mind, a Quality Functional Deployment (QFD) was performed.
A QFD weighs the stakeholder requirements (the "whats") with the "hows", or engineering methods in a weighted design matrix shown below.
The QFD analysis is designed to inform engineers what the highest priority methods are based on customer feedback.
This gives stakeholders a "voice" in the design in a compact matrix format.

\subsubsection{House of Quality} \label{sssec:hoq}
The House of Quality (HOQ) is the product generated by a QFD analysis.
The left side of the matrix defines the customer desires with an associated weight or priority for each.
This data is collected by canvassing the stakeholders and getting their feedback on their priorities.

The middle of the matrix is dedicated with the engineering methods.
Here, the design engineers add the methods they think are required to fulfill the projects requirements.
The numbers throughout the matrix are the strength of the relationship between the requirement and method. 
The scale is the Fibonacci sequence from 0-8 with higher numbers indicating a stronger relationship.
For example, SR-03 has a middling relationship with most of the engineering methods and a very strong (8) relationship with the "Battery Capacity" method.
However, it does not correlate at all (0) with the storage capacity method.

The "roof" or top of the matrix is the inter-relationship between the different engineering methods.
The grading is slightly different with "-", "0", "+" indicating a detrimental, non-existent, or positive relation with multiple of each denoting the strength.
As an example, the cost of Thetis has varying degrees of negative association with each of the other engineering methods.
The type of IMU, GPS, storage method, battery capacity, and enclosure size all add cost to the project and therefore are detrimental to this method.

The right side of the matrix is part of the competitive analysis where Thetis is compared with the other products in use by stakeholders.
Each product is rated on a 1-5 scale of increasing quality for each stakeholder requirement.
This rating is produced based on their capabilities and performance as determined by the stakeholders.
From the matrix, we can see that Thetis has a strong overall rating with regard to all the requirements where the Lowell MAT-1 struggles with the cost and measurement requirements and the iPhone is strong overall except its price and access for students.

At the bottom of the matrix is the technical performance analysis.
The first two rows rate each engineering method with an importance which is described by Equation \ref{eq:hoq_importance} and \ref{eq:hoq_rel_importance}.
The importance of each method informs the design engineers what they should be focussing on during development and what is most important to the stakeholders.
Beneath that is a technical comparison of Thetis and competing products across the engineering methods.
This provides a quick breakdown of each product through the lense of the engineering methods, providing some insight to stakeholders of the benefit of Thetis over competitors.

\begin{gather}
	\label{eq:hoq_importance}
	I = \sum_{n=1}^N{w_n \times R_n} \\
	\begin{aligned}
		\text{where } &I \text{ is the engineering method's importance} \\
					  &N \text{ is the number of stakeholder requirements} \\
					  &w_n \text{ is the weight of a stakeholder requirement, } n \\
					  &R_n \text{ is the strength of the relationship between the requirement and method}
	\end{aligned} \notag
\end{gather}

\begin{gather}
	\label{eq:hoq_rel_importance}
	RI = \frac{I_m}{\sum{\textbf{I}}} \\
	\begin{aligned}
		\text{where } &RI \text{ is the engineering method's relative importance} \\
					  &I_m \text{ is the current method's importance} \\
					  &\textbf{I} \text{ is the vector of all the method's importance} \\
	\end{aligned} \notag
\end{gather}

\begin{landscape}
	\begin{table}
		\caption[House of Quality]{The House of Quality matrix for the Thetis instrumentation package.}
		\label{tab:hoq}
		\centering
		\includegraphics[height=\textwidth-24pt]{../include/ThetisHOQ.pdf}
	\end{table}
\end{landscape}

\section{Concept of Operations} \label{sec:conops}
Thetis is envisioned to be an all-in-one data logging solution that can provide real-time calculations of vessel orientation and position in real-time at a low cost.
In a normal operating case, Thetis will be placed near the center of gravity of a floating vessel and turned on to begin recording.
The user can then connect Thetis to the ship network or use its local WiFi access point to monitor the system and adjust configuration settings.
These configuration settings include different modes that change how Thetis behaves and what data it records.

\paragraph*{9DOF AHRS Mode} When placed into the 9DOF AHRS mode, Thetis will record the vessel acceleration, rotation rate, magnetic heading, and attitude at a set interval according to the user.
This mode is the most verbose recording method and can provide a lot of information on how the vessel is reacting to the current sea conditions. 
Users can specify if they want to record the filtered and fused data as well as the raw data from the sensors.
This option gives them the ability to run their own analysis in post using different software filtering techniques that may increase accuracy relative to what Thetis could achieve in-situ.

\paragraph*{9DOF INS Mode} When placed into the 9DOF INS mode, Thetis incorporates the built-in GPS to its recording functionality.
The GPS module provides real-time position, velocity, course, and error at up to 10 Hz.
This provides a more accurate estimate of the vessel's current position and how it changes over time.
This mode can also provide basic waypoint navigation services to an automated controller for low-cost basic autonomy applications.
Thetis Revision G is specifically designed for this application as its dual independent CAN busses can transmit data to a central controller over the NMEA2000 protocol, making it easier to integrate with unmanned vessels or manned vessels with electronic helms.

\paragraph*{WEAVE Mode} The Wave Estimator Algorithm for VEssels (WEAVE) mode is a special mode that allows Thetis to predict the wave heights encountered by the vessel in real-time.
The algorithm is explained more in depth in Section \ref{sec:weave}.
This mode allows Thetis to communicate the estimated current sea conditions to a central controller or operator so that they make the appropriate decisions with the operation of the vessel.
The biggest application of this algorithm in the unmanned technology sector where the unmanned vessel can integrate these estimates into its world model and make better decisions about the best course and speed it should pursue.
Again, the inclusion of dual independent CAN busses on Revision G makes this feature easier to integrate on electronically-driven vessels.

\section{Conceptual Design} \label{sec:conceptual_design}
The general design of the Thetis instrumentation package was built around the principles of capability, manufacturability, and affordability.
The parts selected for the design had to offer a suite of capabilities that would enable a wide range of projects.
While Thetis was designed primarily for monitoring the movement of floating bodies, it can be adapted for use in general robotics, embedded AI research, and other datalogging tasks.
Thetis is also envisioned to be continued by other endeavoring students, so it has to be easily manufacturable with a single-sided design that can be assembled by hand using tweezers and a hot-air gun.
All of this had to be designed with low-cost readily-available components in mind.
Thetis was originally designed at the start of the global chip shortage in 2020, so parts were limited in choice, especially the IMU.
It is also assumed that Thetis will be lost at some point during testing.
This is just an inevitability during field work, so keeping the cost down would also reduce the impact of such a loss on a project's budget.

\subsection{System Requirements} \label{ssec:system_requirements}
To guide Thetis' design, a series of system requirements were generated that would need to be met in order to certify the design as "complete".
These requirements were derived from the House of Quality (Table \ref{tab:hoq}) and the stakeholder requirements (Section \ref{ssec:stakeholder_reqs}).
Each requirement is categorized into subsections and given a numerical designation.
The requirement is then given as a clear statement of fact with only one consideration given per requirement.
A comment may be associated with each requirement that provides additional context or relevant information.

As the design matures, each requirement will need to be verified in the design. This can be done in four separate ways:

\paragraph*{Inspection} The nondestructive examination of a product or system using one or more of the five senses (visual, auditory, olfactory, tactile, taste). 
It may also include simple physical manipulation and measurements.

\paragraph*{Demonstration} The manipulation of the product or system as it is intended to be used to verify that the results are as planned or expected.								

\paragraph*{Test} The verification of a product or system using a controlled and predefined series of inputs, data, or stimuli to ensure that the product or system will produce a very specific and predefined output as specified by the requirements.								

\paragraph*{Analysis} The verification of a product or system using models, calculations and testing equipment.
Analysis allows someone to make predictive statements about the typical performance of a product or system based on the confirmed test results of a sample set or by combining the outcome of individual tests to conclude something new about the product or system.
It is often used to predict the breaking point or failure of a product or system by using nondestructive tests to extrapolate the failure point.								

For some requirements, there are specific tests that need to be performed in order to validate the requirement.
These tests are detailed more thoroughly in Chapter \ref*{chap:testing_and_validation}.
There is also a field that enables comments on the performance of the validation test for that specific requirement.

The final column of this requirement table is the requirement status.
There are multiple statuses a requirement can have:

\begin{itemize}
	\item \textbf{Under Review (UR)}: Requirement has been submitted and is under review,
	\item \textbf{Accepted (A)}: Requirement has been reviewed and accepted into the document,
	\item \textbf{Rejected (R)}: Requirement has been reviewed and rejected from the document,
	\item \textbf{Testing in Progress (TIP)}: Requirement is currently being tested,
	\item \textbf{Test Successful (TS)}: Requirement successfully passed testing, but is not yet delivered,				
	\item \textbf{Test Failure (TF)}: Requirement failed testing and needs further development, and
	\item \textbf{Delivered (D)}: Requirement has been fully realized and delivered.
\end{itemize}

Below is a table describing the system requirements for the Thetis instrumentation package.

\includepdf[landscape=true, page=-, width=\textheight, offset=0 -0.25in, pagecommand={}]{../include/ThetisReqs.pdf}

\subsection{Functional Block Diagram} \label{ssec:block_diagram}
Factoring in the design principles of capability, manufacturability, and affordability, along with the stakeholder requirements listed in Section \ref{ssec:stakeholder_reqs}, a block diagram was constructed that integrated the crucial parts and drew out their interactions.
This block diagram shows the data sharing relationships in blue and the power relationships in warm colors.
Labels on the specific lines indicate the specific communication protocol or voltage level being used by the line.
Explanations for these protocols and acronyms can be found in the Appendix.

\begin{figure}[h!]
	\label{fig:thetis_block_diagram}
	\caption[Thetis RevF5 Block Diagram]{A block diagram representation of the Thetis RevF5 instrumentation board.}
	\centering
	\includegraphics[width=5in]{design/block_diagram.png}
\end{figure}

\subsection{Functional Flow Diagram} \label{ssec:flow_diagram}
Based off the block diagram and interviews with potential end users, a notional flow diagram for the firmware was created.
The code was designed to be modular and allow for new features to be quickly added or removed with separate libraries.
Additionally, any functions that need to be called, can be executed at specific times to increase computational efficiency and reduce the chance of race conditions occurring.
Note that this block diagram only includes the base firmware.
Breakdowns for the algorithmic flows for different operating modes will be given in their respective sections.

\begin{figure}[h!]
	\label{fig:thetis_flow_diagram}
	\caption[Base Firmware Flow Diagram]{A flow diagram representation of the base firmware of the Thetis instrumentation board.}
	\centering
	\includegraphics[width=5in]{design/flow_diagram.png}
\end{figure}

\subsection{Failure Mode, Effect, and Criticality Analysis} \label{ssec:fmeca}
Since Thetis is intended to be used by end users who may not have a solid background in programming or electrical skills, it is important to identify potential flaws in the design and attempt to mitigate them.
Each potential flaw is given a weighting from 0 to 10 inclusive for both the probability that they will occur, as well as the failure severity if they do. By multiplying these two values together, a Risk Priority Number (RPN) is created that highlights the severity of a potential failure mode. The RPNs are categorized into three groupings:

\paragraph*{LOW} These are RPNs with a value below 2.5 and represent little risk to the system. 
These are denoted with green highlights in the FMECA chart below.

\paragraph*{MEDIUM} These are RPN's between 2.5 and 7.5 that are represented with yellow highlights below.
Typically, these failure modes represent a noticeable threat to the system and the mitigations should be carefully implemented.

\paragraph*{HIGH} These are the highest risk RPNs between 7.5 and 10 and are represented with red highlights.
They are the most severe and should be mitigated at all cost during and after the product development cycle.

The probabilities are generally conjured from past experience, the failure ratings of parts, and other factors that are carefully mapped out and documented over time.
However, since Thetis is using hobby-grade materials and failures are not generally well-documented for the parts, the probabilities represented herein are the best guess of the author based of his experience and best guess.
The same applies for the criticality score for each potential failure.

\begin{landscape}
	\begingroup
		\label{tab:fmeca}
		% \centering
		\vspace*{-1in}\includegraphics[trim={0 0 0 0}, height=6.75in, page=1]{../include/ThetisFMECA.pdf}
		\vspace*{-1in}\captionof{table}[Failure Mode, Effect, and Criticality Analysis, hypcap=true]{A summary of all possible failure modes and their expected effects, likelihoods, criticalities, and mitigations on the Thetis system.}
		\newpage
		\includegraphics[height=6.75in, page=2]{../include/ThetisFMECA.pdf}
		\newpage
		\includegraphics[height=6.75in, page=3]{../include/ThetisFMECA.pdf}
		\newpage
		\includegraphics[height=6.75in, page=4]{../include/ThetisFMECA.pdf}
		\newpage
		\includegraphics[height=6.75in, page=5]{../include/ThetisFMECA.pdf}
		\newpage
		\includegraphics[height=6.75in, page=6]{../include/ThetisFMECA.pdf}
	\endgroup
\end{landscape}

\section{Final Design} \label{sec:final_design}
After carefully considering all the design criteria from the stakeholder requirements and system requirements, Thetis began several design revisions.
The first design revision, Rev F1, was a functional proof of concept.
It incorporated many of the base design features of later Thetis revisions, but relied on a breakout board for the IMU mounted to the bottom of the board and had the battery placed on top.
This forced the battery to be smaller than the desired capacity and overfilled the enclosure, causing excessive compression and stress when the enclosure was tightened and secured.

[INSERT IMAGE OF REVISION F1]

The next revision, F2, changed to a new microcontroller version that simplified the circuit while providing the same capability of the previous revision.
This version also switched from a Micro SD card receptacle to a soldered SMD flash memory chip.
This chip maintained the same capacity requirements from the stakeholders, but took up a fraction of the space on the board.
However, since this chip was directly soldered to the board, the only way to offload date was through the microcontroller either through an FTP server, or through the USB interface.
This is not ideal - especially in the early testing phases, as those features are more complex to implement programmatically and test data cannot be easily offloaded if there is an issue with the microcontroller.
This revision also kept the breakout board for the IMU on the back, giving it the same space constraint problem as its predecessor.

[INSERT IMAGE OF REVISION F2]

For Revision F3, some minor changes were made to the diagnostic LEDs and user inputs.
Several discrete LEDs for logging, error notification, and low battery, were replaced by a single addressable RGB LED that could flash different colors and patterns to convey the system state or errors.
The dedicated log enable button was also removed in favor of using the boot select button for both purposes.
However, this method was entirely flawed as the log enable button relies on an interrupt input to trigger the system to begin recording.
On the ESP32 microcontroller, an interrupt tied to GPIO 0 (the boot select pin) would cause the system to crash and force a reset.
Therefore, the entire design had to be scrapped due to this design flaw.

[INSERT IMAGE OF REVISION F3]

Revision F4 was the most radical design change of the series.
It marked a migration to all SMD components (no breakout board for the IMU) and incorporated all of the design lessons from the previous revision.
However, the IMU that was used in previous revisions, the Bosch BNO055 was amongst the many IMUs affected by the Great Chip Shortage and was therefore unavailable.
So, this design had to adapt by incorporating a new, previously untested IMU, the STdevices LSM6DSO32.
This new IMU does not have a magnetometer and at the time of its design, they were hard to find in stock at any distributors.
So, in anticipation of the Chip Shortage ending, the BNO055 was incorporated to the design, but not populated, giving this board the unique opportunity of having either or both IMUs present - a useful feature for more accurate sensor fusion, but a terrible prospect for software integration.
Additionally, this design reintroduced the micro SD card receptacle, but this time, the SMD flash chip was laid out beneath it.
This provided the assembler to determine which storage system they wanted: easier to use micro SD, or more secure and reliable SMD flash.
Programmatically, these devices work the same, so the software cost was minimal while providing some flexibility.
However, this design was also doomed as the newly reintroduced log enable button was not integrated into the design properly and the chip select pin for the storage device was connected to an incorrect pin.
This latter issue forced the microcontroller to crash and reset every time is tried to write to the external flash memory, necessitating a new board revision.

[INSERT IMAGE OF REVISION F4 (BOTH RENDERED AND ACTUAL)]

The final revision is the most refined version that full realizes all the features Thetis is meant to incorporate while being easy to assemble and use.
The BNO055 was fully removed from the system in favor of adding a dedicated magnetometer, the STdevices LIS3MDL.
By reorganizing some components, the SMD flash ship and micro SD card receptacle were placed side-by-side enabling both primary and secondary storage services, enabling backups and improving reliability.
Then, to improve the battery monitoring capabilities, a battery gauge IC was added.
The MAX17048 is a monitoring IC that runs a mathematical model of the battery's discharge curve given its amp-hour capacity and current operating voltage.
This data is reported to the microcontroller as the current battery percentage or life remaining - making this a crucial part of monitoring performance and operations of Thetis when deployed.
Component types and placements were also streamlined to improve manufacturability and allow the potential for the device to be more easily assembled by a pick and place machine.
This also allows students who have never assembled PCBs before to more easily take up the task and build these boards themselves.

[INSERT IMAGE OF REVISION F5 (BOTH RENDERED AND ACTUAL)]

The next sections detail the assembly process in more detail and provide the schematics and PCB layout for Revision F5.
The schematics for the previous revisions can be found in the appendix.

\subsection{Assembly Technique} \label{ssec:assembly_techniques}
Thetis was designed with surface mount soldering as the primary assembly technique.
This technique differs from traditional soldering as the components are so small that a soldering iron is ineffective in mounting components to the board.
Many of the ICs used on the final Thetis revision do not have exposed legs or pads that can be touched with an iron, so solder paste and hot air are required.

[INSERT COMPARISON SHOT OF THROUGH HOLE AND SURFACE MOUNT SOLDERING]

\paragraph*{Solder Deposition} First, the bare PCB is placed beneath a stencil and secured with tape.
It is important that all of the pads on the PCB are aligned with the cutouts in the stencil as the solder paste must be evenly and thoroughly distributed on the board.
When the PCB is in place, a line of paste is placed on one side and smoothly dragged along the cutouts with even pressure applied throughout.
When the stencil is removed, there should be a healthy deposit of solder paste on each pad as shown in the rightmost picture of Figure \ref{fig:stencil_process}

[INSERT PICTURE SERIES SHOWING STENCIL LAYING, SOLDER PASTE APPLICATION, AND RESULTANT DEPOSIT]

\paragraph*{Component Placement} From here, components can be placed onto the PCB carefully using tweezers.
Some components measure in at tenths of an inch across and require placement tolerances of hundredths of an inch.
Thankfully, in some areas, the surface tension of the solder when melting will forgive slightly misplaced components and drag them into the appropriate spots.
However, it is important not to smear the solder as it may inadvertently bridge pads together and create shorts and undesired behavior.
Throughout assembling these boards, this particular issue was the most common during the assembly process and occurred regularly on the USB-C receptacle, and IMU ICs where the pins are close together.

\paragraph*{Reflow Soldering} When all of the components are placed, the PCB can be placed into a reflow oven for baking.
The oven used for this process uses infrared radiation to evenly heat the board through a set profile.
The temperature profile is specified by the solder paste manufacturer and gives ample time for the components to heat up and the paste to transform from a viscous mixture, to a solid metallic connection.
The entire process from putting the board beneath the stencil to assembled and ready for inspection can take anywhere from 3 hours for a novice assembler, to 45 minutes for a more experienced one.

[INSERT PICTURE SERIES SHOWING COMPONENT PLACEMENT, SOLDERING OVEN, AND FINAL RESULT]

\paragraph*{Inspection} Following a successful reflow, the board must be inspected for defects.
The most common are solder bridges between pads that create undesired shorts and can damage parts.
The inspection will also check that parts are in the correct locations and orientations and that no shorts exist between power rails and ground.
A microscope and good multimeter are crucial to this process.

If a soldering defect is discovered, the board can be placed onto a small heating plate to melt the solder and remove the part.
Then, the part can be removed and the pads on both the component and board are cleaned up using a soldering iron to ensure the proper amount of solder is present.
Once the pads are cleaned, either hot air or the heating pad can be used to heat the afflicted area and remelt the solder so the part can be replaced on the board.
The board is inspected again and if the issue is cleared, the board is ready for testing.

[INSERT A PICTURE SERIES ON INSPECTING THE ASSEMBLED BOARD, REPLACING A COMPONENT, AND THEN REINSPECTING IT]

\paragraph*{Testing} When the board passes a visual inspection and there are no power shorts present, the board is plugged into a programming computer via the USB port.
The microcontroller is placed into the bootloader mode by holding the boot button and pressing the reset button.
This should cause the microcontroller to show up as a USB device on the computer.
From here, the latest Thetis firmware can be flashed to the new board.
By default, when plugged into USB, the board enters a diagnostic testing mode that prints out the boot and initialization status.
By opening a serial console, the assembler can see this process in real time.
If there are any errors while initializing, the firmware will report which device is having a problem.
The assembler will then need to do a deeper inspection to find the cause of the error and rectify it.

[INSERT PICTURE SERIES OF BOOTING AND TESTING THE NEW BOARD]

Once the new board boots without issue, the board is ready for deployment and can be used by operators and intended end users.

\includepdf[landscape=true, width=\textheight, offset=-0in -0.25in, pagecommand={\subsection{Schematic} \label{ssec:revf5_schematic}}]{../include/Thetis_RevF5_SCH.pdf}

% \subsection{PCB Design} \label{ssec:revf5_pcb}

% \subsection{Unit Testing} \label{ssec:unit_testing}